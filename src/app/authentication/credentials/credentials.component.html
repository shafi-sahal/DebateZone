<form
  appFocusInvalidInput
  #formDirective="ngForm"
  [formGroup]="(isSignUp | async) ? signUpForm : loginForm"
  (ngSubmit)="onSubmit()">
  <div class="container-inputs">
    <mat-form-field *ngIf="isSignUp | async">
      <mat-label>{{inputDetails.name.label}}</mat-label>
      <input
        matInput
        [placeholder]="inputDetails.name.placeholder"
        formControlName="name"
       >
    </mat-form-field>
    <p
      class="invalid"
      *ngIf="name?.hasError('pattern')">
      Give a valid name, buddy
    </p>

    <mat-form-field *ngIf="isSignUp | async" class="username">
      <mat-label>{{inputDetails.username.label}}</mat-label>
      <div class="container-input-with-spinner">
        <input
          class="with-spinner"
          matInput
          [placeholder]="inputDetails.username.placeholder"
          formControlName="username">
        <mat-spinner *ngIf="(username?.statusChanges | async) === 'PENDING'" [diameter]="25"></mat-spinner>
      </div>
    </mat-form-field>
    <div class="invalid">
      <p *ngIf="username?.hasError('isTooSmall')">
        Username must be atleast 5 characters long
      </p>
      <p *ngIf="username?.hasError('isTooBig')">
        Username must only have a maximum of 30 characters
      </p>
      <p *ngIf="username?.hasError('disallowedStartingCharacter')">
        Username should not start with a period
      </p>
      <p *ngIf="username?.hasError('disallowedCharacter')">
        Username should only contain letters, numbers, periods, underscores, hyphens and '@'
      </p>
      <p *ngIf="username?.hasError('disallowedEndingCharacter')">
        Username should not end with a period
      </p>
      <p *ngIf="username?.hasError('isDuplicateUsername')">
        Username already taken. Try a different one
      </p>
    </div>
    <p *ngIf="(username?.statusChanges | async) === 'VALID'" class="valid">
      Username is available!!!
    </p>

    <p class="invalid-center" *ngIf="showLoginError">Invalid login details</p>
    <mat-form-field>
      <mat-label>{{inputDetails.email.label}}</mat-label>
      <div class="container-input-with-spinner">
        <input
          #inputEmail
          class="with-spinner"
          matInput
          type="email"
          [placeholder]="inputDetails.email.placeholder"
          formControlName="email"
          (input)="clearErrors(email, shouldAsyncValidateEmail)">
          <mat-spinner *ngIf="(email?.statusChanges | async) === 'PENDING'" [diameter]="25"></mat-spinner>
      </div>
    </mat-form-field>
    <div class="invalid" *ngIf="isSignUp | async">
      <p *ngIf="email?.hasError('pattern')">
        Give a valid email, buddy
      </p>
      <p *ngIf="(email?.statusChanges | async) === 'INVALID' && email?.hasError('isDuplicateEmail')">
        An account with the same email already exists
      </p>
    </div>

    <mat-form-field *ngIf="isSignUp | async">
      <mat-label>{{inputDetails.country.label}}</mat-label>
      <mat-select
        #countrySelect
        [value]="_country.name"
        [placeholder]="inputDetails.country.placeholder"
        (selectionChange)="onCountrySelectionChange($event.value)"
        (openedChange)="onCountryOpenedChanged()">
        <mat-select-trigger
          *ngIf="countrySelect.value === labelUnknownDialCode; else countryName"
          class="invalid">
          {{countrySelect.value}}
        </mat-select-trigger>
        <ng-template
          #countryName>
          <mat-select-trigger class="valid-select">{{_country.name}}</mat-select-trigger>
        </ng-template>
        <mat-option>
          <lib-mat-select-search
          [list]="countries"
          [searchProperties]="['dialCode', 'name']"
          [clearSearchInput]="true"
          (filtered)="filteredCountries = $event">
        </lib-mat-select-search>
        </mat-option>
        <mat-option
          appMultiLine
          *ngFor="let country of filteredCountries; trackBy: trackFunction"
          [value]="country.name">
          <div class="container-country">
            <p>{{country.name}}</p><p>{{country.dialCode}}</p>
          </div>
        </mat-option>
        <mat-option
          *ngIf="countrySelect.value === labelUnknownDialCode"
          [value]="labelUnknownDialCode">
          {{labelUnknownDialCode}}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <div class="container-mobile" *ngIf="isSignUp | async">
      <mat-form-field class="dial-code">
      <mat-label>Dial Code</mat-label>
        <div [class]="classDialCode">+
          <input
            #dialCodeInput
            class="dial-code"
            required
            matInput
            [value]="_country.dialCode.replace('+', '')"
            (focus)="classDialCode = 'dial-code-normal'"
            (blur)="setDialCodeWeight()"
            (input)="onDialCodeInput()">
        </div>
      </mat-form-field>

      <mat-form-field class="mobile">
        <mat-label>{{inputDetails.mobile.label}}</mat-label>
        <div class="container-input-with-spinner">
          <input
            #inputMobile
            matInput
            formControlName="mobile"
            [placeholder]="inputDetails.mobile.placeholder"
            (input)="onMobileInput(inputMobile.value); clearErrors(mobile, shouldAsyncValidateMobile)">
            <mat-spinner *ngIf="(mobile?.statusChanges | async) === 'PENDING'" [diameter]="25"></mat-spinner>
        </div>
      </mat-form-field>
    </div>
    <div class="invalid">
      <div *ngIf="mobile?.hasError('invalidMobile')">
        <p *ngIf="countrySelect.value === labelUnknownDialCode; else invalidMobileForCountry">Invalid mobile number</p>
        <ng-template #invalidMobileForCountry>Invalid mobile number for the given country</ng-template>
      </div>
      <p *ngIf="(mobile?.statusChanges | async) === 'INVALID' && mobile?.hasError('isDuplicateMobile')">
        An account with the same mobile number already exists
      </p>
    </div>

    <mat-form-field>
      <mat-label>{{inputDetails.password.label}}</mat-label>
      <div class="password">
        <input
        matInput
        [type]="credentialsService.getInputType()"
        [placeholder]="inputDetails.password.placeholder"
        formControlName="password"
        >
        <mat-icon (click)="credentialsService.toggleVisibility()">{{credentialsService.getVisibilityIcon()}}</mat-icon>
      </div>
    </mat-form-field>

     <p
      class="invalid"
      *ngIf="(isSignUp | async) && password?.hasError('minlength')">
      Password must contain atleast 8 characters
    </p>

    <button class="diagonal-rounded-large" mat-raised-button type="submit" color="primary">{{buttonText}}</button>
  </div>
</form>
